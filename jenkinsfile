// Rev 0.0.2
@Library('jenkins-library-local') _

// CONFIG DE LA APLICACION
String configFile = "/Volumes/TOSH-600/Broidery/Jenkins/Broidery-pipeline/config.json"
// FIN CONFIG DE LA APLICACION

String RESULTADO = ""

node('master') {
    // Get configuration file.
    configuration = readJSON file: configFile
    
    // Get environmentProperties
    configuration.ENVIRONMENTS.each {
        if(it.NAME == ENVIRONMENT) {
            environmentProperties = it
            }
        }
    
    mailList = configuration.MAILS_NOTIFICATION_TO
}

pipeline {
    agent any
    environment{
        SERVER_CREDENTIALS = credentials("${configuration.CREDENTIALS}")
    }
    parameters {
        choice(name:'ENVIRONMENT', choices: ['DEV','PRD'], description: """<h4 style="color: green; text-aling: left;">Ambiente a deployar</h4> """)
    }
    stages {
        stage('DELETE LAST BUILD') {
            steps {
                sh " rm -rf *"
                sh "rm -rf /usr/local/var/www/*"
                // sh '''
                //     export PATH=/usr/local/share/supervisor:$PATH
                //     export PATH=/usr/local/share/nginx:$PATH
                //     supervisorctl stop broidery
                //     nginx -s stop
                // '''
            }
        }

        stage('CLONE REPO DOTNET') {
            steps {
                sh "mkdir Broidery-backend"
                invokeJob('TEMPLATES/SOURCE_CHECKOUT_GIT',['WS':configuration.CHECKOUTS[0].WS +"/Repositorio", 'REPOSITORY': configuration.CHECKOUTS[0].SCM_URL, 'BRANCH': configuration.CHECKOUTS[0].SCM_BRANCH ])
                sh "cp -r /Users/lucas/.jenkins/workspace/TEMPLATES/SOURCE_CHECKOUT_GIT/ /Users/lucas/.jenkins/workspace/Broidery/Broidery-backend"
            }
        }
        
        stage('CLONE REPO ANGULAR') {
            steps {
                sh """mkdir "${configuration.CHECKOUTS[1].WS}" """
                invokeJob('TEMPLATES/SOURCE_CHECKOUT_GIT',['WS': configuration.CHECKOUTS[1].WS +"/Repositorio",'REPOSITORY': configuration.CHECKOUTS[1].SCM_URL, 'BRANCH': configuration.CHECKOUTS[1].SCM_BRANCH ])
                sh "cp -r /Users/lucas/.jenkins/workspace/TEMPLATES/SOURCE_CHECKOUT_GIT/ /Users/lucas/.jenkins/workspace/Broidery/Broidery-frontend"
            }
        }

        stage('CODE ANALYSIS'){
            steps{
                withSonarQubeEnv('SonarQube'){
                    script {
                        def sonnarScannerHome = tool 'sonar-scanner'
                     sh """${sonnarScannerHome}bin/sonar-scanner -Dsonar.projectKey=broideryBackend -Dsonar.projectName=Broidery-backend -Dsonar.projectVersion=1.0 -Dsonar.sourceEncoding=UTF-8 -Dsonar.visualstudio.enable=true -Dsonar.sources="${configuration.CHECKOUTS[0].WS}" -Dsonar.issuesReport.html.enable=true -Dsonar.host.url=http://192.168.0.135:9000 -Dsonar.projectBaseDir="${configuration.CHECKOUTS[0].WS}"/Broidery -Dsonar.visualstudio.solution=Broidery.sln """
                     sh """${sonnarScannerHome}bin/sonar-scanner -Dsonar.projectKey=broideryFrontend -Dsonar.projectName=Broidery-frontend -Dsonar.projectVersion=1.0 -Dsonar.sourceEncoding=UTF-8 -Dsonar.visualstudio.enable=true -Dsonar.sources="${configuration.CHECKOUTS[1].WS}"/src -Dsonar.issuesReport.html.enable=true -Dsonar.host.url=http://192.168.0.135:9000 -Dsonar.projectBaseDir="${configuration.CHECKOUTS[1].WS}" """
                    }
                    dir(configuration.CHECKOUTS[0].WS){
            /*      sh '''export PATH=/usr/local/share/dotnet:$PATH
                    dotnet restore Broidery.sln
                    '''
                */    
        //                script{
         //                   def sonnarMsBuildScannerHome = tool 'sonar-msbuild'
          //                  sh """ ${sonnarMsBuildScannerHome}/sonar-scanner-4.4.0.2170/bin/sonar-scanner Broidery.sln /p:ProductVersion=1.0.0.${env.BUILD_NUMBER} """
                           /*  mono """ ${sonnarMsBuildScannerHome}/sonar-scanner-4.4.0.2170/bin/sonar-scanner begin /k:Broidery-backend /d:sonar.host.url="http://192.168.0.135/:9000" /d:sonar.login="${sonar-token}" """
                            mono "msbuild /t:Rebuild"
                            mono """ ${sonnarMsBuildScannerHome}/sonar-scanner-4.4.0.2170/bin/sonar-scanner end /d:sonar.login="${sonar-token}" """
                            */
          //              }
                    }
                }
            }
        }
        stage('BUILD FRONTEND'){
            tools { nodejs  'node' }
            steps {
            sh    """
                    cd "${configuration.CHECKOUTS[1].WS}"
                    npm i
                    npm run build
                    """
            }
        }

        stage('BUILD BACKEND') {
            when {
                expression { params.ENVIRONMENT == 'DEV' }
            }
            steps {
            sh '''
            export PATH=/usr/local/share/dotnet:$PATH
            cd Broidery-backend/Broidery/Broidery.Api.DockerStartup
            dotnet restore
            dotnet build  
            dotnet publish --configuration Release --runtime osx-x64                          
            '''
            }
        }

        stage('ZIP BINARY FILES') {
            steps {
                // sh '''#!/bin/zsh 
                // cd Broidery-backend/Broidery/Broidery.Api.DockerStartup/bin/Debug/netcoreapp3.1/
                // zip -r ./publish.zip ./publish
                // cd /Users/lucas/.jenkins/workspace/Broidery/Broidery-frontend/
                // zip -r ./dist.zip ./dist 
                // mv /Users/lucas/.jenkins/workspace/Broidery/Broidery-backend/Broidery/Broidery.Api.DockerStartup/bin/Debug/netcoreapp3.1/publish.zip .
                // mv dist.zip ../
                // ls ../
                // '''
                sh "ls"
            }
        }
        
        stage('DEPLOY TO LOCAL NGINX') {
            steps {                
                sh 'cp -r Broidery-frontend/dist/Broidery-frontend/ /usr/local/var/www/ '
                sh 'cp -r Broidery-backend/Broidery/Broidery.Api.DockerStartup/bin/Release/netcoreapp3.1/osx-x64/ /usr/local/var/www/'
                sh 'date >> date.txt'
                echo 'FRONTEND PUBLICADO EN http://localhost:8081/ Y EN http://192.168.0.135:8081/'
                echo 'BACKEND PUBLICADO EN http://localhost:8082/ Y EN http://192.168.0.135:8082/'
            }
        }

    }
    post {
        always{
            script{    
                env.RESULTADO = currentBuild.currentResult
                
                slackSend channel: 'jenkins-test', color: '#439FE0', message:  configuration.APP + " | " + env.RESULTADO + " | "  + ENVIRONMENT + " | " + " build nº" + BUILD_NUMBER , teamDomain: 'papa-cultiva', notifyCommitters: false, tokenCredentialId: 'slack-token'
                
                emailext attachmentsPattern: '*.txt',
                subject: "Jenkins: " + configuration.APP + " | " + env.RESULTADO + " | "  + ENVIRONMENT + " | " + " build nº" + BUILD_NUMBER ,
                body: '''${SCRIPT, template="jenkins_dtv_3.template"}''',
                to: "${mailList}"
    
            }
        }        
    }
}
